---
title: "Correia Consultant Agency"
author: "Pedro Morais, Braedon Fiume, Matt Adams"
date: "Add a date"
output:
  rmdformats::readthedown:
    css: "custom.css"
    thumbnails: false
    highlight: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
library(tidyverse)
library(rvest)
library(knitr)
library(janitor)
library(tidytext)
library(countrycode)
library(rworldmap)
library(viridis)
library(GGally)
library(plotly)
library(dplyr)
library(stringr)
library(leaflet)
library(gganimate)
library(lubridate)
library(maps)
library(ggthemes)
library(RColorBrewer)

library(ggpubr)
library(grid)
library(gridExtra)
library(GGally)


starbucks <- read_csv("Data/starbucks.csv")
city_income <- read_csv("Data/kaggle_income.csv")
county_pop <- read_csv("Data/us_county.csv")
unemployment <- read_csv("Data/unemployment.csv")
starbucks_positive <- read_csv("Data/starbucks_positive.csv")
starbucks_negative <- read_csv("Data/starbucks_negative.csv")

#Standard unemployment data used for each county
unemployment_county <- unemployment %>%
  separate(County, into = c("County", "Blank")
           , sep = "County"
           , remove = FALSE) %>%
  group_by(County) %>%
  na.omit() %>%
  summarize("Avg. Unemployment Rate" = mean(Rate, na.rm=TRUE)) 

```

# Introduction
Starbucks’ gargantuan $26 billion of revenue in 2019 is resounding evidence that Americans, above everything, love their coffee. They prove it time and time again, most recently during the current pandemic: some, unable to relinquish their daily ‘bucks, waited hours on end in long drive-thru lines to get their fix when coffee shops were closed for in-person operations.
	
It is no surprise, then, that Starbucks owns more than 8,000 stores across the US, and continues to grow everyday. These sheer numbers are reflective of a company that is about more than just coffee, having a significant influence on US society and culture with (often controversial) initiatives such as removing religious references from holiday-themed cups. In addition, Starbucks is known for treating their employees extremely well by providing health coverage, tuition coverage, and 401(k) plans, which again reinforces their highly-regarded brand.

As such, the astounding popularity of the chain in the country and the prospect of further expansion raises important questions. What can the current distribution of Starbucks stores tell us about societal factors across the country? Which factors should the brand consider when expanding into new locations? How can companies like Starbucks, which pride themselves in a positive social and environmental outlook, incorporate such values into their corporate strategy - especially in the current pandemic?

# Overview of Analysis

In order to answer these questions, we sought to understand the relationship between state-level social and economic factors, such as income and unemployment; and the distribution of Starbucks locations in the US. Furthermore, we wanted to understand what company behavior and decision-making could look like with a more social-minded approach, instead of considering sheer profits. Starbucks shops, after all, can be significant contributors to social good on a localized level by providing stable jobs that open up avenues for growth and education.

As such, in this project, we conduct a consulting case-study of Starbucks, analysing what insights are gained from the current distribution of stores in the US and providing socially-minded recommendations for new locations in which the brand can expand. We start this endeavor with a spatial analysis of Starbucks stores across the US, exploring the relationship between store density and income/unemployment level in each state. We then complement this analysis with a text-based sentiment analysis of recent tweets mentioning Starbucks, and explore how these sentiments vary across location. Finally, we use these variables to conduct a clustering analysis of states in the US, in order to determine the different “types” of states under which Starbucks operates. We proceed to use these clusters to identify the ideal locations for the brand to build new stores.

# Data

In order to conduct this analysis, we collected the following data:

- The [Starbucks Locations Worldwide](https://www.kaggle.com/starbucks/store-locations) dataset available on Kaggle and provided by Starbucks Corporation, including a record for every Starbucks or subsidiary store location that was operation during February 2017.
- The [US Household Income Statistics](https://www.kaggle.com/goldenoakresearch/us-household-income-stats-geo-locations?select=kaggle_income.csv) dataset, available on Kaggle and provided by the Golden Oak Research group, containing information on US cities’ average income.
- The [US Unemployment Rate by County](https://www.kaggle.com/jayrav13/unemployment-by-county-us/data) dataset avaiable on Kaggle and provided by the US Department of Labor's Bureau of Labor Statistics, containing unemployment and population data at the US county level from 1990-2016.
- The most recent 18,000 tweets containing the string "Starbucks" or "starbucks" in their text, scraped using the [RTweet](https://cran.r-project.org/web/packages/rtweet/rtweet.pdf) package to interface with the Twitter API.

Check the links in the bullets above for access to each of the data sources!

# Distribution of Starbucks Across the US

The first step of our analysis was to understand how Starbucks stores are distributed across the US:

```{r figure1, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

#US locations; except Hawaii and Alaska
us_stars <- starbucks %>%
  filter(Country=="US") %>%
  rename(State=`State/Province`) %>%
  filter(State!="AK") %>%
  filter(State!="HI")
  
usa <- map_data(map = "state"
                       , region = ".")
usa_states <- usa %>%
  select(region, group) %>%
  group_by(region) %>%
  summarize(
    group=sum(group)/n()
  )

state_info <- data.frame(state_full = tolower(state.name)
                         , State = state.abb
                         , Region = state.region)

us_map_star <- us_stars %>%
  left_join(state_info, by = "State") %>%
  left_join(usa_states, by = c("state_full" = "region"))

usa_states <- map_data(map = "state"
                       , region = ".") 

city_star <- us_map_star %>%
  group_by(City) %>%
  summarize(
    Count = n()
  )

city_count_star <- us_map_star %>%
  left_join(city_star, by = "City") %>%
  mutate(Count = round(Count, 1))

city_count_star$color <- cut(city_count_star$Count, c(0, 10, 50, 100, 300), 
                             labels = c("0-10"
                                        ,"10-50"
                                        , "50-100"
                                        , "100+"))


ggplot() +
  geom_polygon(data = usa_states, aes(x=long, y = lat, group = group), color="black", fill="gray", alpha=0.3) +
  geom_point(data=city_count_star, aes(x = Longitude, y = Latitude, group=group, size=color, color=color)) +
  scale_size_discrete(range=c(1,7)) +
  scale_color_viridis(discrete = TRUE) +
  theme_void() +
  labs(color = "# of Starbucks",
       size = "# of Starbucks",
       title = "Starbucks Stores in the US by City",
       subtitle = "As of February 2017")


```

Looking at the plot above, displaying the distribution and density of Starbuck locations across the US, we can see that Starbucks locations are extremely clustered along the coast of the US, and less prominent within states in the Rocky Mountain and Midwestern regions of the country. This is evidence that there is a correlation between income and Starbuck store location, as we see a concentration of stores in the richer parts of the country, such as several states in the Northeast and California. This is corroborated by the heavy concentration of Starbucks in the major cities within each state, as opposed to being spread out across the state’s counties. Looking at the map, one can easily identify major cities such as New York, Los Angeles, Houston, Miami and Boston as Starbucks hotspots. 

With strong evidence of high spatial concentration of starbucks stores and a correlation between income and number of stores, we wanted to understand if that gave rise to any patterns regarding sentiment towards Starbucks. Specifically, we theorized that areas with more Starbucks stores or higher income should have a more positive sentiment towards the brand. In the following section, we test this hypothesis using text-based sentiment analysis of recent tweets that mention Starbucks.

# Cosumer Sentiments Towards Starbucks Across US

After using the RTweets package to scrape text and locations for the latests 18,000 tweets mentioning Starbucks, we calculated the proportion of negative/positive words (as defined by NRC Lexicon) in each state. 

As mentioned previously, our initial hypothesis was that states with larger densities of starbucks would tweet more positive and less negative opinions. However, when observing the plots below, states with more Starbucks, such as California, Texas, Florida, and New York, all have a lower proportion of positive words in tweets and high proportion of negative words in tweets compared to other states in the US. Additionally, the states with a lower amount of Starbucks, such as Wisconsin, Iowa, Kansas, and Mississippi, had a higher proportion of positive words and lower proportion of negative words in tweets. This leads to the conclusion that it may be more beneficial for Starbucks to build its stores in states it is not currently heavily established in, according to consumer sentiment analysis.

```{r figure3, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

pos <- ggplot(starbucks_positive, aes(x = long, y = lat, group = group
                      , fill = positive.proportion)) +
  scale_fill_viridis() +
  geom_polygon(color = "white") +
  theme_void() +
  coord_fixed(ratio = 1.3) +
  labs(title= "Proportion of Positive Words in Tweets Per State",
       fill = "Proportion",
       caption = "*Grey states have no twitter data") +
    theme(legend.title = element_text(color = "black", size = 8),
        legend.text = element_text(color = "black", size = 8))

neg <- ggplot(starbucks_negative, aes(x = long, y = lat, group = group
                      , fill = negative.proportion)) +
  scale_fill_viridis() +
  geom_polygon(color = "white") +
  theme_void() +
  coord_fixed(ratio = 1.3) +
  labs(title= "Proportion of Negative Words in Tweets Per State",
       fill = "Proportion",
       caption = "*Grey states have no twitter data") +
    theme(legend.title = element_text(color = "black", size = 8),
        legend.text = element_text(color = "black", size = 8))

consumer_sentiment <- ggarrange(pos, neg, ncol = 1, nrow = 2)

consumer_sentiment

```


# Clustering by State

Motivated by the potential that Starbucks might want to expand into areas it has not heavily invested in, we sought to understand how we could segment states into categories in order to determine how Starbucks might strategize differently in each of them.

## State-Level Factors

We thus employed a k-means clustering algorithm to US States, using the following variables in order to categorize them:

- Average Proportion of Negative Sentiment in Tweets
- Average Income
- Average Unemployment Rate
- Number of Starbucks

## State-Level Clusters

Using the elbow plot below, we found that 5 clusters would get us the most efficient information gain while keeping results interpretable.

```{r figure5, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

income_state <- city_income %>%
  group_by(State_Name, State_ab) %>%
  na.omit() %>%
  summarize("Avg. Income" = mean(Mean, na.rm=TRUE)) %>%
  mutate(State = tolower(State_Name)) %>%
  select(State, `Avg. Income`, State_ab)

unemployment_state <- unemployment %>%
  group_by(State) %>%
  na.omit() %>%
  summarize("Avg. Unemployment Rate" = mean(Rate, na.rm=TRUE)) %>%
  mutate(State = tolower(State))

starbucks_state <- starbucks %>%
  group_by(`State/Province`) %>%
  na.omit() %>%
  summarize("Num. Starbucks" = n())
  
star_neg <- starbucks_negative %>%
  select(negative.proportion, state_full) %>%
  group_by(state_full) %>%
  na.omit() %>%
  summarize(
    negative.proportion = mean(negative.proportion, na.rm=TRUE)
  )

state_factors <- income_state %>%
  left_join(unemployment_state, by="State") %>%
  left_join(star_neg, by = c("State"="state_full")) %>%
  left_join(starbucks_state, by = c("State_ab" = "State/Province"))

state_factors$`Avg. Unemployment Rate`[10] <- 7.6

final_state_factors <- state_factors %>%
  na.omit() %>%
  ungroup()

final_final_state_factors <- final_state_factors %>%
  mutate_if(is.numeric, funs(`std`=scale(.) %>% as.vector())) 

only_std_values <- final_final_state_factors %>%
  select(`Avg. Unemployment Rate_std`, `Avg. Income_std`, negative.proportion_std, `Num. Starbucks_std`)

set.seed(75)
#Create a folder with 10 0s.
fig <- matrix(NA, nrow=10, ncol=2)

#Collecting information for each cluster 
for (i in 1:10){
  fig[i,1] <- i
  fig[i,2] <- kmeans(only_std_values, centers = i, nstart = 20)$tot.withinss
}

#Visualizing "Elbow Plot"
ggplot(data = as.data.frame(fig), aes(x = V1, y = V2)) +
  geom_point() + 
  geom_line() +
  scale_x_continuous(breaks=c(1:10)) +
  labs(x = "K", y = expression("Total W"[k]), title="Cluster Analysis")

```

### Visualization of Cluster
The results of the clustering algorithm are displayed in the visualization below:


```{r figure6, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

km_out_std <- kmeans(only_std_values, centers = 5, nstart = 20)

clust_5_std <- final_final_state_factors %>%
  mutate(clust5_std = as.character(km_out_std$cluster)) %>%
  arrange(clust5_std) %>%
  mutate(State_Name=tolower(State_Name))

usa_states <- map_data(map = "state"
                       , region = ".")

final_cluster <- clust_5_std %>%
  left_join(usa_states, by = c("State_Name" = "region"))

ggplot() +
geom_polygon(data = usa_states, aes(x=long, y = lat, group = group), color="black", fill="black", alpha=0.3) +
geom_polygon(data= final_cluster, aes(x = long, y = lat, group = group, fill = clust5_std), color="black") +
  geom_polygon(color = "black") +
  theme_void() +
  coord_fixed(ratio = 1.3) +
  labs(fill = "Clusters") +
  theme(legend.position="bottom")

```

### Cluster Characteristics
The matrix below shows the distribution of each cluster among the four categories. Cluster 1, which is composed solely of California, is characterized by having the highest number of Starbucks stores by a large margin (a total of 2821!). It’s also interesting to note that California has high average income and a high unemployment rate, which is unique since there is an inverse correlation between the two in other states. Cluster 2 represents the states with lower income than most but also relatively low unemployment, being a special case of the less-wealthy states.  Cluster 3, composed solely of Vermont, is characterized by having the highest negative consumer sentiment. Cluster 4 represents the most wealthy states in the country, having high average income and a median unemployment rate. Finally, Cluster 5 represents the most impoverished states in the US, having a high unemployment rate, low average income and low number of Starbucks stores.

```{r figure7, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

vars_std = c("Avg. Unemployment Rate_std", "Avg. Income_std", "negative.proportion_std", "Num. Starbucks_std")

ggpairs(data = final_cluster
        , aes(color = clust5_std) 
        , columns = vars_std
        , upper = list(continuous = "blank")
        , title = "Distributions of Clusters") +
  labs(caption = "*Important to Note: Values are standardized")

```

## Final List of States

Having segmented states by their characteristics, we decided to pick one from each cluster in order to determine what a socially-minded strategy for Starbucks within that group of states might look like. To do so, we decided to pick the centermost state within each cluster, as the state “most representative” of that cluster. For California and Vermont, this was trivial, since they were the only states within their respective clusters. For the other three clusters, we calculated the distance from each state to its respective center and picked the states with the minimum distance. From this analysis, we concluded the final 5 states, each representative of their own cluster, are: 

```{r figure8, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

#Code we used for each cluster to determine its' most representative state
clust_1 <- final_state_factors %>%
  mutate_if(is.numeric, funs(`std`=scale(.) %>% as.vector())) %>%
  mutate(Cluster = as.character(km_out_std$cluster)) %>%
  arrange(Cluster) %>%
  mutate(State_Name=tolower(State_Name)) %>%
  filter(Cluster==1) 

clust_1 <- clust_1 %>%
  mutate(dist = sqrt(
                      (`Avg. Unemployment Rate_std` - km_out_std$centers[1,1])^2 +
                      (`Avg. Income_std` - km_out_std$centers[1,2])^2 +
                      (`negative.proportion_std` - km_out_std$centers[1,3])^2 +
                      (`Num. Starbucks_std` - km_out_std$centers[1,3])^2)
  ) %>%
  arrange(dist)


```

- Virginia
- Vermont
- Tennessee
- Iowa
- California

# Clustering by County

## County-Level Factors

- Average Income
- Average Unemployment Rate
- Number of Starbucks

Step-by Step Process

1. Cluster Analysis
2. Creating clusters based on appropriate number of centers
3. Determine the most suitable cluster of counties

## Determining Amount of Clusters for Each State {.tabset .tabset-fade .tabset-pills}


### Virginia

```{r figure9, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

va_income_city <- city_income %>%
  filter(State_Name=="Virginia") %>%
  group_by(City) %>%
  na.omit() %>%
  summarize("Avg. Income" = mean(Mean, na.rm=TRUE)) 

va_starbucks_city <- starbucks %>%
  filter(`State/Province`=="VA") %>%
  group_by(`City`) %>%
  summarize("Num. Starbucks" = n())

va_city_info <- va_income_city %>%
  left_join(va_starbucks_city, by = c("City")) %>%
  mutate_all(~replace(., is.na(.), 0))

va_county_info <- city_income %>%
  filter(State_ab=="VA") %>%
  select(City, County) %>%
  separate(County, into = c("County", "Blank")
           , sep = "County"
           , remove = FALSE) %>% 
  distinct() %>%
  left_join(va_city_info, by = c("City")) %>%
  group_by(County) %>%
  summarize(
    "Avg. Income" = mean(`Avg. Income`), 
    "Num. Starbucks" = sum(`Num. Starbucks`)
  )

va_county_factors <- va_county_info %>%
  left_join(unemployment_county, by = c("County")) %>%
  na.omit()

va_final_county <- va_county_factors %>%
  mutate_if(is.numeric, funs(`std`=scale(.) %>% as.vector())) %>%
  select(County, `Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)
  
va_final_county_factors <- va_final_county %>%
  select(`Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)

set.seed(75)
#Create a folder with 10 0s.
fig <- matrix(NA, nrow=10, ncol=2)

#Collecting information for each cluster 
for (i in 1:10){
  fig[i,1] <- i
  fig[i,2] <- kmeans(va_final_county_factors, centers = i, nstart = 20)$tot.withinss
}

#Visualizing "Elbow Plot"
va_cluster_analysis <- ggplot(data = as.data.frame(fig), aes(x = V1, y = V2)) +
  geom_point() + 
  geom_line() +
  scale_x_continuous(breaks=c(1:10)) +
  labs(x = "K", y = expression("Total W"[k]))

```


```{r figure10, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

# apply the k-means algorithm (set the seed to make the results reproducible)
set.seed(75)
va_county_km <- kmeans(va_final_county_factors, centers = 5, nstart = 20)

# add cluster assignments to the data frame
va_county_clust <- va_final_county %>%
  mutate(Cluster = as.character(va_county_km$cluster)) %>%
  arrange(Cluster) %>%
  mutate(County=tolower(County))

usa_states <- map_data(map = "county"
                       , region = "virginia") %>%
  select(subregion, long, lat, group)

va_final_cluster <- va_county_clust %>%
  mutate(County=str_trim(County)) %>%
  left_join(usa_states, by = c("County" = "subregion"))

va_geo <- ggplot() +
  geom_polygon(data = usa_states, aes(x=long, y = lat, group = group), color="black", fill="black", alpha=0.3) +
  geom_polygon(data=va_final_cluster, aes(x = long, y = lat, group=group, fill=Cluster), color="black") +
  scale_size_continuous(range=c(1,12)) +
  scale_color_viridis(trans="log") +
  labs(title = "Clusters in Virginia",
       caption = "*Grey states have no income or unemployment information",
       fill="Clusters") +
  theme_void()

```

```{r figure11, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

rename_va_county_clust <- va_county_clust %>%
  rename(`Income`=`Avg. Income_std`) %>%
  rename(`Num. Starbucks`=`Num. Starbucks_std`) %>%
  rename(`Unemployment`=`Avg. Unemployment Rate_std`) 
  
vars_std = c("Income", "Num. Starbucks", "Unemployment")

va_cluster_matrix <- ggpairs(data = rename_va_county_clust
        , aes(color = Cluster) 
        , columns = vars_std
        , upper = list(continuous = "blank"))

va_cluster_matrix <- grid.grabExpr(print(va_cluster_matrix))

va_geo
ggarrange(
  # Second row with box and dot plots
  ggarrange(va_cluster_matrix, va_cluster_analysis, ncol = 2),
  nrow = 1     # Label of the line plot
  )

#Compile for the end result
va_poor_county <- va_county_clust %>%
  filter(Cluster==4) %>%
  mutate(County=str_to_title(County)) %>%
  inner_join(va_county_factors, by="County") %>%
  select(County, `Avg. Income`, `Num. Starbucks`,`Avg. Unemployment Rate`)

```

Cluster characteristics, explain why we chose cluster 4


### Vermont

Cluster Analysis
```{r figure12, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

vt_income_city <- city_income %>%
  filter(State_Name=="Vermont") %>%
  group_by(City) %>%
  na.omit() %>%
  summarize("Avg. Income" = mean(Mean, na.rm=TRUE)) 

vt_starbucks_city <- starbucks %>%
  filter(`State/Province`=="VT") %>%
  group_by(`City`) %>%
  summarize("Num. Starbucks" = n())

vt_city_info <- vt_income_city %>%
  left_join(vt_starbucks_city, by = c("City")) %>%
  mutate_all(~replace(., is.na(.), 0))

vt_county_info <- city_income %>%
  filter(State_ab=="VT") %>%
  select(City, County) %>%
  separate(County, into = c("County", "Blank")
           , sep = "County"
           , remove = FALSE) %>% 
  distinct() %>%
  left_join(vt_city_info, by = c("City")) %>%
  group_by(County) %>%
  summarize(
    "Avg. Income" = mean(`Avg. Income`), 
    "Num. Starbucks" = sum(`Num. Starbucks`)
  )

vt_county_factors <- vt_county_info %>%
  left_join(unemployment_county, by = c("County")) %>%
  na.omit()

vt_final_county <- vt_county_factors %>%
  mutate_if(is.numeric, funs(`std`=scale(.) %>% as.vector())) %>%
  select(County, `Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)
  
vt_final_county_factors <- vt_final_county %>%
  select(`Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)

set.seed(75)
#Create a folder with 10 0s.
fig <- matrix(NA, nrow=7, ncol=2)

#Collecting information for each cluster 
for (i in 1:7){
  fig[i,1] <- i
  fig[i,2] <- kmeans(vt_final_county_factors, centers = i, nstart = 20)$tot.withinss
}

#Visualizing "Elbow Plot"
vt_cluster_analysis <- ggplot(data = as.data.frame(fig), aes(x = V1, y = V2)) +
  geom_point() + 
  geom_line() +
  scale_x_continuous(breaks=c(1:7)) +
  labs(x = "K", y = expression("Total W"[k]))

```


```{r figure13, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

# apply the k-means algorithm (set the seed to make the results reproducible)
set.seed(75)
vt_county_km <- kmeans(vt_final_county_factors, centers = 4, nstart = 20)

# add cluster assignments to the data frame
vt_county_clust <- vt_final_county %>%
  mutate(Cluster = as.character(vt_county_km$cluster)) %>%
  arrange(Cluster) %>%
  mutate(County=tolower(County))

usa_states <- map_data(map = "county"
                       , region = "vermont") %>%
  select(subregion, long, lat, group)

vt_final_cluster <- vt_county_clust %>%
  mutate(County=str_trim(County)) %>%
  left_join(usa_states, by = c("County" = "subregion"))

vt_geo <- ggplot() +
  geom_polygon(data = usa_states, aes(x=long, y = lat, group = group), color="black", fill="black", alpha=0.3) +
  geom_polygon(data=vt_final_cluster, aes(x = long, y = lat, group=group, fill=Cluster), color="black") +
  scale_size_continuous(range=c(1,12)) +
  scale_color_viridis(trans="log") +
  labs(title = "Clusters in Vermont",
       caption = "*Grey states have no income or unemployment information",
       fill="Clusters") +
  theme_void()

```

Cluster characteristics, explain why we chose cluster 1

```{r figure14, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

rename_vt_county_clust <- vt_county_clust %>%
  rename(`Income`=`Avg. Income_std`) %>%
  rename(`Num. Starbucks`=`Num. Starbucks_std`) %>%
  rename(`Unemployment`=`Avg. Unemployment Rate_std`) 
  
vars_std = c("Income", "Num. Starbucks", "Unemployment")

vt_cluster_matrix <- ggpairs(data = rename_vt_county_clust
        , aes(color = Cluster) 
        , columns = vars_std
        , upper = list(continuous = "blank"))

vt_cluster_matrix <- grid.grabExpr(print(vt_cluster_matrix))


vt_geo
ggarrange(
  # Second row with box and dot plots
  ggarrange(vt_cluster_matrix, vt_cluster_analysis, ncol = 2),
  nrow = 1     # Label of the line plot
  )

vt_poor_county <- vt_county_clust %>%
  filter(Cluster==1) %>%
  mutate(County=str_to_title(County)) %>%
  inner_join(vt_county_factors, by="County") %>%
  select(County, `Avg. Income`, `Num. Starbucks`,`Avg. Unemployment Rate`)

```

### Tennessee

Cluster Analysis
```{r figure15, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

tn_income_city <- city_income %>%
  filter(State_Name=="Tennessee") %>%
  group_by(City) %>%
  na.omit() %>%
  summarize("Avg. Income" = mean(Mean, na.rm=TRUE)) 

tn_starbucks_city <- starbucks %>%
  filter(`State/Province`=="TN") %>%
  group_by(`City`) %>%
  summarize("Num. Starbucks" = n())

tn_city_info <- tn_income_city %>%
  left_join(tn_starbucks_city, by = c("City")) %>%
  mutate_all(~replace(., is.na(.), 0))

tn_county_info <- city_income %>%
  filter(State_ab=="TN") %>%
  select(City, County) %>%
  separate(County, into = c("County", "Blank")
           , sep = "County"
           , remove = FALSE) %>% 
  distinct() %>%
  left_join(tn_city_info, by = c("City")) %>%
  group_by(County) %>%
  summarize(
    "Avg. Income" = mean(`Avg. Income`), 
    "Num. Starbucks" = sum(`Num. Starbucks`)
  )

tn_county_factors <- tn_county_info %>%
  left_join(unemployment_county, by = c("County")) %>%
  na.omit()

tn_final_county <- tn_county_factors %>%
  mutate_if(is.numeric, funs(`std`=scale(.) %>% as.vector())) %>%
  select(County, `Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)
  
tn_final_county_factors <- tn_final_county %>%
  select(`Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)

set.seed(75)
#Create a folder with 10 0s.
fig <- matrix(NA, nrow=10, ncol=2)

#Collecting information for each cluster 
for (i in 1:10){
  fig[i,1] <- i
  fig[i,2] <- kmeans(tn_final_county_factors, centers = i, nstart = 20)$tot.withinss
}

#Visualizing "Elbow Plot"
tn_cluster_analysis <- ggplot(data = as.data.frame(fig), aes(x = V1, y = V2)) +
  geom_point() + 
  geom_line() +
  scale_x_continuous(breaks=c(1:10)) +
  labs(x = "K", y = expression("Total W"[k]))


```


#### Visualizing clusters

```{r figure16, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

# apply the k-means algorithm (set the seed to make the results reproducible)
set.seed(75)
tn_county_km <- kmeans(tn_final_county_factors, centers = 4, nstart = 20)

# add cluster assignments to the data frame
tn_county_clust <- tn_final_county %>%
  mutate(Cluster = as.character(tn_county_km$cluster)) %>%
  arrange(Cluster) %>%
  mutate(County=tolower(County))

usa_states <- map_data(map = "county"
                       , region = "tennessee") %>%
  select(subregion, long, lat, group)

tn_final_cluster <- tn_county_clust %>%
  mutate(County=str_trim(County)) %>%
  left_join(usa_states, by = c("County" = "subregion"))

tn_geo <- ggplot() +
  geom_polygon(data = usa_states, aes(x=long, y = lat, group = group), color="black", fill="black", alpha=0.3) +
  geom_polygon(data=tn_final_cluster, aes(x = long, y = lat, group=group, fill=Cluster), color="black") +
  scale_size_continuous(range=c(1,12)) +
  scale_color_viridis(trans="log") +
  labs(title = "Clusters in Tennessee",
       caption = "*Grey states have no income or unemployment information") +
  theme_void()

```

Cluster characteristics, explain why we chose cluster 4

```{r figure17, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE, width=20, height=20}


rename_tn_county_clust <- tn_county_clust %>%
  rename(`Income`=`Avg. Income_std`) %>%
  rename(`Num. Starbucks`=`Num. Starbucks_std`) %>%
  rename(`Unemployment`=`Avg. Unemployment Rate_std`) 
  
vars_std = c("Income", "Num. Starbucks", "Unemployment")

tn_cluster_matrix <- ggpairs(data = rename_tn_county_clust
        , aes(color = Cluster) 
        , columns = vars_std
        , upper = list(continuous = "blank"))

tn_cluster_matrix <- grid.grabExpr(print(tn_cluster_matrix))

tn_geo
ggarrange(
  # Second row with box and dot plots
  ggarrange(tn_cluster_matrix, tn_cluster_analysis, ncol = 2),
  nrow = 1     # Label of the line plot
  )

tn_poor_county <- tn_county_clust %>%
  filter(Cluster==2) %>%
  mutate(County=str_to_title(County)) %>%
  inner_join(tn_county_factors, by="County") %>%
  select(County, `Avg. Income`, `Num. Starbucks`,`Avg. Unemployment Rate`)

```

### Iowa

Cluster Analysis
```{r figure18, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

ia_income_city <- city_income %>%
  filter(State_Name=="Iowa") %>%
  group_by(City) %>%
  na.omit() %>%
  summarize("Avg. Income" = mean(Mean, na.rm=TRUE)) 

ia_starbucks_city <- starbucks %>%
  filter(`State/Province`=="IA") %>%
  group_by(`City`) %>%
  summarize("Num. Starbucks" = n())

ia_city_info <- ia_income_city %>%
  left_join(ia_starbucks_city, by = c("City")) %>%
  mutate_all(~replace(., is.na(.), 0))

ia_county_info <- city_income %>%
  filter(State_ab=="IA") %>%
  select(City, County) %>%
  separate(County, into = c("County", "Blank")
           , sep = "County"
           , remove = FALSE) %>% 
  distinct() %>%
  left_join(ia_city_info, by = c("City")) %>%
  group_by(County) %>%
  summarize(
    "Avg. Income" = mean(`Avg. Income`), 
    "Num. Starbucks" = sum(`Num. Starbucks`)
  )

ia_county_factors <- ia_county_info %>%
  left_join(unemployment_county, by = c("County")) %>%
  na.omit()

ia_final_county <- ia_county_factors %>%
  mutate_if(is.numeric, funs(`std`=scale(.) %>% as.vector())) %>%
  select(County, `Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)
  
ia_final_county_factors <- ia_final_county %>%
  select(`Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)

set.seed(75)
#Create a folder iath 10 0s.
fig <- matrix(NA, nrow=10, ncol=2)

#Collecting information for each cluster 
for (i in 1:10){
  fig[i,1] <- i
  fig[i,2] <- kmeans(ia_final_county_factors, centers = i, nstart = 20)$tot.withinss
}

#Visualizing "Elbow Plot"
ia_cluster_analysis <- ggplot(data = as.data.frame(fig), aes(x = V1, y = V2)) +
  geom_point() + 
  geom_line() +
  scale_x_continuous(breaks=c(1:10)) +
  labs(x = "K", y = expression("Total W"[k]))

```


#### Visualizing clusters

```{r figure19, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

# apply the k-means algorithm (set the seed to make the results reproducible)
set.seed(75)
ia_county_km <- kmeans(ia_final_county_factors, centers = 4, nstart = 20)

# add cluster assignments to the data frame
ia_county_clust <- ia_final_county %>%
  mutate(Cluster = as.character(ia_county_km$cluster)) %>%
  arrange(Cluster) %>%
  mutate(County=tolower(County))

usa_states <- map_data(map = "county"
                       , region = "iowa") %>%
  select(subregion, long, lat, group)

ia_final_cluster <- ia_county_clust %>%
  mutate(County=str_trim(County)) %>%
  left_join(usa_states, by = c("County" = "subregion"))

ia_geo <- ggplot() +
  geom_polygon(data = usa_states, aes(x=long, y = lat, group = group), color="black", fill="black", alpha=0.3) +
  geom_polygon(data=ia_final_cluster, aes(x = long, y = lat, group=group, fill=Cluster), color="black") +
  scale_size_continuous(range=c(1,12)) +
  scale_color_viridis(trans="log") +
  labs(title = "Clusters in Iowa",
       caption = "*Grey states have no income or unemployment information") +
  theme_void()


```

Cluster characteristics, explain why we chose cluster 5

```{r figure20, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

rename_ia_county_clust <- ia_county_clust %>%
  rename(`Income`=`Avg. Income_std`) %>%
  rename(`Num. Starbucks`=`Num. Starbucks_std`) %>%
  rename(`Unemployment`=`Avg. Unemployment Rate_std`) 
  
vars_std = c("Income", "Num. Starbucks", "Unemployment")

ia_cluster_matrix <- ggpairs(data = rename_ia_county_clust
        , aes(color = Cluster) 
        , columns = vars_std
        , upper = list(continuous = "blank"))

ia_cluster_matrix <- grid.grabExpr(print(ia_cluster_matrix))

ia_geo
ggarrange(
  # Second row with box and dot plots
  ggarrange(ia_cluster_matrix, ia_cluster_analysis, ncol = 2),
  nrow = 1     # Label of the line plot
  )

#Cluster 3
ia_poor_county <- ia_county_clust %>%
  filter(Cluster==3) %>%
  mutate(County=str_to_title(County)) %>%
  inner_join(ia_county_factors, by="County") %>%
  select(County, `Avg. Income`, `Num. Starbucks`,`Avg. Unemployment Rate`)

```


### California

Cluster Analysis
```{r figure21, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

ca_income_city <- city_income %>%
  filter(State_Name=="California") %>%
  group_by(City) %>%
  na.omit() %>%
  summarize("Avg. Income" = mean(Mean, na.rm=TRUE)) 

ca_starbucks_city <- starbucks %>%
  filter(`State/Province`=="CA") %>%
  group_by(`City`) %>%
  summarize("Num. Starbucks" = n())

ca_city_info <- ca_income_city %>%
  left_join(ca_starbucks_city, by = c("City")) %>%
  mutate_all(~replace(., is.na(.), 0))

ca_county_info <- city_income %>%
  filter(State_ab=="CA") %>%
  select(City, County) %>%
  separate(County, into = c("County", "Blank")
           , sep = "County"
           , remove = FALSE) %>% 
  distinct() %>%
  left_join(ca_city_info, by = c("City")) %>%
  group_by(County) %>%
  summarize(
    "Avg. Income" = mean(`Avg. Income`), 
    "Num. Starbucks" = sum(`Num. Starbucks`)
  )

ca_county_factors <- ca_county_info %>%
  left_join(unemployment_county, by = c("County")) %>%
  na.omit()

ca_final_county <- ca_county_factors %>%
  mutate_if(is.numeric, funs(`std`=scale(.) %>% as.vector())) %>%
  select(County, `Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)
  
ca_final_county_factors <- ca_final_county %>%
  select(`Avg. Income_std`, `Num. Starbucks_std`, `Avg. Unemployment Rate_std`)

set.seed(75)
#Create a folder with 10 0s.
fig <- matrix(NA, nrow=10, ncol=2)

#Collecting information for each cluster 
for (i in 1:10){
  fig[i,1] <- i
  fig[i,2] <- kmeans(ca_final_county_factors, centers = i, nstart = 20)$tot.withinss
}

#Visualizing "Elbow Plot"
ca_cluster_analysis <- ggplot(data = as.data.frame(fig), aes(x = V1, y = V2)) +
  geom_point() + 
  geom_line() +
  scale_x_continuous(breaks=c(1:10)) +
  labs(x = "K", y = expression("Total W"[k]))

```


#### Visualizing clusters

```{r figure22, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

# apply the k-means algorithm (set the seed to make the results reproducible)
set.seed(75)
ca_county_km <- kmeans(ca_final_county_factors, centers = 4, nstart = 20)

# add cluster assignments to the data frame
ca_county_clust <- ca_final_county %>%
  mutate(Cluster = as.character(ca_county_km$cluster)) %>%
  arrange(Cluster) %>%
  mutate(County=tolower(County))

usa_states <- map_data(map = "county"
                       , region = "california") %>%
  select(subregion, long, lat, group)

ca_final_cluster <- ca_county_clust %>%
  mutate(County=str_trim(County)) %>%
  left_join(usa_states, by = c("County" = "subregion"))

ca_geo <- ggplot() +
  geom_polygon(data = usa_states, aes(x=long, y = lat, group = group), color="black", fill="black", alpha=0.3) +
  geom_polygon(data=ca_final_cluster, aes(x = long, y = lat, group=group, fill=Cluster), color="black") +
  scale_size_continuous(range=c(1,12)) +
  scale_color_viridis(trans="log") +
  labs(title = "Clusters in California",
       caption = "*Grey states have no income or unemployment information") +
  theme_void()



```

Cluster characteristics, explain why we chose cluster 1

```{r figure23, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

rename_ca_county_clust <- ca_county_clust %>%
  rename(`Income`=`Avg. Income_std`) %>%
  rename(`Num. Starbucks`=`Num. Starbucks_std`) %>%
  rename(`Unemployment`=`Avg. Unemployment Rate_std`) 
  
vars_std = c("Income", "Num. Starbucks", "Unemployment")

ca_cluster_matrix <- ggpairs(data = rename_ca_county_clust
        , aes(color = Cluster) 
        , columns = vars_std
        , upper = list(continuous = "blank"))

ca_cluster_matrix <- grid.grabExpr(print(ca_cluster_matrix))

ca_geo
ggarrange(
  # Second row with box and dot plots
  ggarrange(ca_cluster_matrix, ca_cluster_analysis, ncol = 2),
  nrow = 1     # Label of the line plot
  )

ca_poor_county <- ca_county_clust %>%
  filter(Cluster==1) %>%
  mutate(County=str_to_title(County)) %>%
  inner_join(ca_county_factors, by="County") %>%
  select(County, `Avg. Income`, `Num. Starbucks`,`Avg. Unemployment Rate`)
```


# Final Recommendations

Summarize overall process and thinking and impact of starbucks. Show the data table of all important counties from clusters we chose:


```{r figure24, echo = FALSE, error=FALSE, warning=FALSE, message=FALSE}

final_counties <- ca_poor_county %>%
  bind_rows(ia_poor_county) %>%
  bind_rows(vt_poor_county) %>%
  bind_rows(va_poor_county) %>%
  bind_rows(tn_poor_county) 

library(knitr)
library(kableExtra)

kable(final_counties) %>%
  kable_styling(latex_options = "striped")


```


# Limitations and Conclusion

Paragraph here


# Citations

List of important packages/data sets
